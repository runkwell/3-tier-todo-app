AWSTemplateFormatVersion: '2010-09-09'
Description: 'Senior Level Infrastructure: VPC, ALB, ASG, RDS Multi-AZ, CloudFront, and SNS Monitoring.'

Parameters:
  ProjectName:
    Type: String
    Default: todo-project-779922
  EmailNotification:
    Type: String
    Default: your_email@gmail.com
  DBPassword:
    Type: String
    NoEcho: true
    Default: "SeniorSecurePass123!"
  ImageTagPlaceholder:
    Type: String
    Default: "latest"

Mappings:
  RegionMap:
    ap-southeast-1:
      AMI: ami-0df7a207adb9748c7 # Amazon Linux 2 (Verify latest in console)

Resources:
  # --- NETWORK LAYER ---
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags: [{Key: Name, Value: !Sub "${ProjectName}-VPC"}]

  InternetGateway:
    Type: AWS::EC2::InternetGateway

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Subnets
  PublicSubnetAZ1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: ap-southeast-1a
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags: [{Key: Name, Value: !Sub "${ProjectName}-Pub-Subnet-1"}]

  PublicSubnetAZ2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: ap-southeast-1b
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: true
      Tags: [{Key: Name, Value: !Sub "${ProjectName}-Pub-Subnet-2"}]

  PrivateSubnetAZ1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: ap-southeast-1a
      CidrBlock: 10.0.11.0/24
      Tags: [{Key: Name, Value: !Sub "${ProjectName}-Priv-Subnet-1"}]

  PrivateSubnetAZ2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: ap-southeast-1b
      CidrBlock: 10.0.12.0/24
      Tags: [{Key: Name, Value: !Sub "${ProjectName}-Priv-Subnet-2"}]

  # NAT Gateways
  EIP1:
    Type: AWS::EC2::EIP
  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIP1.AllocationId
      SubnetId: !Ref PublicSubnetAZ1

  EIP2:
    Type: AWS::EC2::EIP
  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt EIP2.AllocationId
      SubnetId: !Ref PublicSubnetAZ2

  # --- STORAGE LAYER (S3) ---
  AppBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: share-image-todo-project-779922
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true

  CloudTrailBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "cloudtrail-logs-${AWS::AccountId}-${AWS::Region}"

  # --- SECURITY GROUPS ---
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP/HTTPS from CloudFront (Simplified to all for demo)
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: App Instances Security Group
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp # Allow from ALB
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
        - IpProtocol: tcp # Allow SSH from Bastion
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref BastionSecurityGroup

  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SSH Access
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0

  # --- COMPUTE LAYER ---
  # Bastion Host (EC2_connect)
  BastionHost:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: !FindInMap [RegionMap, !Ref "AWS::Region", AMI]
      SubnetId: !Ref PublicSubnetAZ1
      SecurityGroupIds: [!Ref BastionSecurityGroup]
      Tags: [{Key: Name, Value: EC2_connect}]

  # Jenkins CICD Host
  JenkinsHost:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: !FindInMap [RegionMap, !Ref "AWS::Region", AMI]
      SubnetId: !Ref PublicSubnetAZ2
      SecurityGroupIds: [!Ref BastionSecurityGroup]
      IamInstanceProfile: !Ref JenkinsInstanceProfile
      Tags: [{Key: Name, Value: EC2_Jenkins}]

  # --- AUTO SCALING GROUP ---
  ServerLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        InstanceType: t2.micro
        ImageId: !FindInMap [RegionMap, !Ref "AWS::Region", AMI]
        SecurityGroupIds: [!Ref InstanceSecurityGroup]
        IamInstanceProfile:
          Name: !Ref AppInstanceProfile
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -e
            # Setup environment
            echo IMAGE_TAG=${ImageTagPlaceholder} > /etc/default/fullstack
            # Logic for Docker/ECR (Simplified for script)
            # Trong thuc te, can install docker & docker-compose o day
            yum update -y
            amazon-linux-extras install docker -y
            service docker start
            usermod -a -G docker ec2-user
            curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
            
            # Application deployment
            mkdir -p "/var/www/app"
            cd "/var/www/app"
            cat > docker-compose.yml <<EOF
            version: "3.8"
            services:
              flaskapp:
                image: {{ECR_BACKEND}}:${ImageTagPlaceholder}
                ports: ["5000:5000"]
                environment:
                  - SQLALCHEMY_DATABASE_URI=postgresql://admin:${DBPassword}@${DBInstance.Endpoint.Address}:5432/mydb
              frontend:
                image: {{ECR_FRONTEND}}:${ImageTagPlaceholder}
                ports: ["80:80"]
            EOF
            aws ecr get-login-password --region ap-southeast-1 | docker login --username AWS --password-stdin {{ECR_REPO}}
            /usr/local/bin/docker-compose up -d

  ASGServer1111:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: ASG_server_1111
      VPCZoneIdentifier: [!Ref PrivateSubnetAZ1, !Ref PrivateSubnetAZ2]
      LaunchTemplate:
        LaunchTemplateId: !Ref ServerLaunchTemplate
        Version: !GetAtt ServerLaunchTemplate.LatestVersionNumber
      MinSize: '2'
      MaxSize: '6'
      DesiredCapacity: '4'
      TargetGroupARNs: [!Ref ALBTargetGroup]
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300

  # --- DATABASE (RDS PostgreSQL) ---
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: RDS Subnets
      SubnetIds: [!Ref PrivateSubnetAZ1, !Ref PrivateSubnetAZ2]

  DBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      Engine: postgres
      DBInstanceClass: db.t3.micro
      AllocatedStorage: '20'
      DBSubnetGroupName: !Ref DBSubnetGroup
      MultiAZ: true # Enable replication/HA
      MasterUsername: admin
      MasterUserPassword: !Ref DBPassword
      VPCSecurityGroups: [!Ref DBSecurityGroup]

  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow Postgre access from App Instances
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref InstanceSecurityGroup

  # --- LOAD BALANCER & CLOUDFRONT ---
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Subnets: [!Ref PublicSubnetAZ1, !Ref PublicSubnetAZ2]
      SecurityGroups: [!Ref ALBSecurityGroup]

  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: instance

  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions: [{Type: forward, TargetGroupArn: !Ref ALBTargetGroup}]
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Origins:
          - Id: ALBOrigin
            DomainName: !GetAtt ApplicationLoadBalancer.DNSName
            CustomOriginConfig:
              OriginProtocolPolicy: http-only
          - Id: S3Origin
            DomainName: !GetAtt AppBucket.DomainName
            S3OriginConfig:
              OriginAccessIdentity: ""
        DefaultCacheBehavior:
          TargetOriginId: ALBOrigin
          ViewerProtocolPolicy: allow-all
          ForwardedValues:
            QueryString: true
        CacheBehaviors:
          - PathPattern: "/images/*"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            ForwardedValues:
              QueryString: false

  # --- MONITORING & SCALING ---
  SNSAlarmTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: !Ref EmailNotification
          Protocol: email

  CPUAlarmHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "Scale up if CPU > 60%"
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 60
      AlarmActions: [!Ref ScaleUpPolicy, !Ref SNSAlarmTopic]
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref ASGServer1111
      ComparisonOperator: GreaterThanThreshold

  ScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref ASGServer1111
      AdjustmentType: ChangeInCapacity
      ScalingAdjustment: 2

  # --- IAM ROLES ---
  AppInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: {Service: [ec2.amazonaws.com]}
            Action: ['sts:AssumeRole']
      Policies:
        - PolicyName: ECRPullPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: ['ecr:GetDownloadUrlForLayer', 'ecr:BatchGetImage', 'ecr:GetAuthorizationToken']
                Resource: '*'
  
  AppInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [!Ref AppInstanceRole]

  JenkinsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: {Service: [ec2.amazonaws.com]}
            Action: ['sts:AssumeRole']
      Policies:
        - PolicyName: JenkinsCICDPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: ['ecr:*', 'autoscaling:UpdateAutoScalingGroup', 'ec2:CreateLaunchTemplateVersion']
                Resource: '*'

  JenkinsInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [!Ref JenkinsRole]

Outputs:
  CloudFrontURL:
    Value: !GetAtt CloudFrontDistribution.DomainName
  ALBDNSName:
    Value: !GetAtt ApplicationLoadBalancer.DNSName